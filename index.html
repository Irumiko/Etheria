<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etheria - Roleplay Visual Novel</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%E2%9C%A8%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="css/main.css">

<base target="_blank">
</head>
<body>

    <div id="autosaveIndicator" class="autosave-indicator">
        <span class="autosave-icon">â˜ï¸</span>
        <span class="autosave-text">Guardando...</span>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Cargando datos...</div>
    </div>

    <div id="continuationOverlay" class="vn-continuation-overlay" onclick="if(event.target === this) closeContinuation()">
        <div class="vn-continuation-box">
            <button class="vn-continuation-close" onclick="closeContinuation()" aria-label="Cerrar continuaciÃ³n">âœ•</button>
            <h3 class="vn-continuation-title">ğŸ­ ContinuaciÃ³n de la escena</h3>
            <div id="continuationText" class="vn-continuation-text"></div>
        </div>
    </div>

    <div id="screenReaderAnnouncements" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

    <div id="shortcutsModal" class="modal-overlay" onclick="if(event.target === this) closeModal('shortcutsModal')" role="dialog" aria-modal="true" aria-labelledby="shortcutsTitle">
        <div class="shortcuts-modal">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
                <h3 id="shortcutsTitle" style="font-family:Cinzel,serif;">âŒ¨ï¸ Atajos de teclado</h3>
                <button class="btn-secondary" onclick="closeModal('shortcutsModal')" aria-label="Cerrar ayuda de atajos">Cerrar</button>
            </div>
            <p style="color:var(--text-muted);margin-top:0.35rem;">Atajos disponibles en modo novela visual.</p>
            <div class="shortcuts-list" role="list">
                <div class="shortcut-item" role="listitem"><strong>Espacio</strong><span>Avanzar diÃ¡logo / completar typewriter</span></div>
                <div class="shortcut-item" role="listitem"><strong>â† / â†’</strong><span>Mensaje anterior / siguiente</span></div>
                <div class="shortcut-item" role="listitem"><strong>Esc</strong><span>Cerrar paneles y modales activos</span></div>
                <div class="shortcut-item" role="listitem"><strong>?</strong><span>Mostrar esta ayuda</span></div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel">
        <h3 class="settings-title">âš™ï¸ Ajustes de Lectura</h3>

        <div class="setting-item">
            <label class="setting-label" for="textSpeedSlider">Velocidad del texto</label>
            <input type="range" id="textSpeedSlider" class="setting-slider" min="10" max="100" value="25" oninput="updateTextSpeed(this.value)">
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.3rem;">
                <span>RÃ¡pido</span>
                <span id="speedValue">Normal</span>
                <span>Lento</span>
            </div>
        </div>

        <div class="setting-item">
            <label class="setting-label" for="fontSizeSlider">TamaÃ±o de fuente</label>
            <input type="range" id="fontSizeSlider" class="setting-slider" min="14" max="24" value="19" oninput="updateFontSize(this.value)">
        </div>

        <div class="setting-item">
            <label class="setting-label">Filtro de atmÃ³sfera</label>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setAtmosphere('none')">Normal</button>
                <button class="filter-btn" onclick="setAtmosphere('sepia')">Sepia</button>
                <button class="filter-btn" onclick="setAtmosphere('bw')">B/N</button>
                <button class="filter-btn" onclick="setAtmosphere('cinematic')">Cine</button>
            </div>
        </div>

        <button onclick="closeSettings()" class="btn-primary" style="width: 100%; margin-top: 1rem;">Cerrar</button>
    </div>

    <!-- User Select -->
    <div id="userSelectScreen" class="user-select-screen">
        <div class="profile-particles" id="profileParticles"></div>
        <h1 class="game-title">ETHERIA</h1>
        <p class="game-subtitle">Elige tu perfil para comenzar la aventura...</p>
        <div class="user-cards" id="userCardsContainer">
            <!-- Los perfiles se generarÃ¡n dinÃ¡micamente -->
        </div>
        <div class="welcome-overlay" id="welcomeOverlay">
            <div class="welcome-message">Â¡Bienvenid@ a Etheria! Crea tu primer perfil</div>
        </div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu" class="main-menu hidden">
        <div class="menu-particles" id="particlesContainer"></div>

        <div class="menu-sidebar">
            <div class="menu-brand">
                <h1 class="menu-title">ğŸ“– ETHERIA</h1>
                <p class="menu-subtitle">Â¿QuÃ© deseas hacer hoy?</p>
            </div>

            <div class="menu-container">
                <button class="menu-button primary" onclick="showSection('topics')">
                    <span>âœ¨</span>
                    <span>Nueva Partida</span>
                </button>
                <button class="menu-button" onclick="showSection('gallery')">
                    <span>ğŸ­</span>
                    <span>GalerÃ­a de Personajes</span>
                </button>
                <button class="menu-button" onclick="saveGameFromMenu()">
                    <span>ğŸ’¾</span>
                    <span>Guardar Partida</span>
                </button>
                <button class="menu-button" onclick="loadGameFromMenu()">
                    <span>ğŸ“‚</span>
                    <span>Cargar Partida</span>
                </button>
                <button class="menu-button" onclick="showSection('options')">
                    <span>âš™ï¸</span>
                    <span>Opciones</span>
                </button>
            </div>

            <div class="menu-footer">
                <span id="currentUserDisplay">Jugador</span>
                <button onclick="changeUser()" aria-label="Editar perfil actual">âœï¸ Editar</button>
            </div>
        </div>
    </div>

    <!-- Topics Section -->
    <div id="topicsSection" class="game-section">
        <div class="section-header-bar">
            <h2 class="section-title">âœ¨ Nueva Partida</h2>
            <button class="back-button" onclick="backToMenu()">â† Volver</button>
        </div>
        <div class="section-content">
            <div style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem;">
                <div style="background: var(--bg-card); border-radius: 20px; border: 2px solid var(--border-color); padding: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3 style="font-family: 'Cinzel', serif; color: var(--accent-wood);">Historias</h3>
                        <button onclick="openModal('topicModal')" style="background: var(--accent-wood); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer;">+ Crear</button>
                    </div>
                    <div id="topicsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;"></div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div style="background: var(--bg-card); border-radius: 16px; border: 2px solid var(--border-color); padding: 1.5rem;">
                        <h4 style="font-family: 'Cinzel', serif; color: var(--accent-wood); margin-bottom: 1rem;">ğŸ“Š Progreso</h4>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 12px; text-align: center; margin-bottom: 1rem;">
                            <div id="statTopics" style="font-family: 'Cinzel'; font-size: 2rem; color: var(--accent-wood);">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Historias</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 12px; text-align: center;">
                            <div id="statMsgs" style="font-family: 'Cinzel'; font-size: 2rem; color: var(--accent-wood);">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Mensajes</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Section -->
    <div id="gallerySection" class="game-section">
        <div class="section-header-bar">
            <h2 class="section-title">ğŸ­ GalerÃ­a de Personajes</h2>
            <div style="display: flex; gap: 1rem;">
                <button onclick="openCharacterEditor()" style="background: var(--accent-wood); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer;">+ Nuevo</button>
                <button class="back-button" onclick="backToMenu()">â† Volver</button>
            </div>
        </div>
        <div class="section-content">
            <div class="gallery-toolbar">
                <input type="text" id="gallerySearch" class="search-input" placeholder="ğŸ” Buscar personaje o jugador..." oninput="debounceRenderGallery()">
                <select id="gallerySort" class="sort-select" onchange="renderGallery()">
                    <option value="default">Ordenar...</option>
                    <option value="owner">Por Propietario</option>
                    <option value="name">Por Nombre</option>
                    <option value="race">Por Raza</option>
                </select>
                <span id="galleryCount" style="color: var(--text-muted); font-family: 'Inter', sans-serif; font-size: 0.9rem;"></span>
            </div>
            <div id="galleryGrid" class="gallery-grid"></div>
        </div>
    </div>

    <!-- Options Section -->
    <div id="optionsSection" class="game-section">
        <div class="section-header-bar">
            <h2 class="section-title">âš™ï¸ Opciones</h2>
            <button class="back-button" onclick="backToMenu()">â† Volver</button>
        </div>
        <div class="section-content">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; max-width: 1000px; margin: 0 auto;">
                <div style="background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 20px; padding: 2rem; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸŒ™</div>
                    <h3 style="font-family: 'Cinzel'; color: var(--accent-wood); margin-bottom: 1rem;">Tema Visual</h3>
                    <button onclick="toggleTheme()" class="btn-primary">Cambiar Claro/Oscuro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VN Section -->
    <div id="vnSection" class="game-section vn-section">
        <!-- Contenedores de clima -->
        <div id="weatherContainer" class="weather-container"></div>

        <!-- Info Card -->
        <div class="vn-info-card" id="vnInfoCard">
            <div class="vn-info-avatar" id="vnInfoAvatar">
                <div class="placeholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem;">ğŸ‘¤</div>
            </div>
            <div class="vn-info-details">
                <div class="vn-info-name" id="vnInfoName">Sin personaje</div>
                <div class="vn-info-club" id="vnInfoClub">Selecciona un personaje</div>

                <!-- Sistema de Afinidad - Solo nombre de rango -->
                <div id="affinityDisplay" class="affinity-rank-display hidden">
                    <div class="affinity-rank-name" id="affinityRankName">Desconocidos</div>
                    <div class="affinity-controls-inline">
                        <button class="affinity-btn-inline minus" onclick="modifyAffinity(-1)" title="Disminuir afinidad">âˆ’</button>
                        <button class="affinity-btn-inline plus" onclick="modifyAffinity(1)" title="Aumentar afinidad">+</button>
                    </div>
                </div>

                <div class="vn-info-affection" id="vnInfoAffection" style="display: none;">
                    <span>â¤ï¸</span>
                    <span id="vnAffectionValue">0</span>
                </div>
            </div>
        </div>

        <!-- Controles -->
        <div class="vn-controls">
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="firstMessage()" aria-label="Primer mensaje">
                    <span class="vn-control-icon">Â«</span>
                    <span class="vn-control-label">Inicio</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="previousMessage()" aria-label="Mensaje anterior">
                    <span class="vn-control-icon">â€¹</span>
                    <span class="vn-control-label">AtrÃ¡s</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="nextMessage()" aria-label="Mensaje siguiente">
                    <span class="vn-control-icon">â€º</span>
                    <span class="vn-control-label">Siguiente</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="lastMessage()" aria-label="Ãšltimo mensaje">
                    <span class="vn-control-icon">Â»</span>
                    <span class="vn-control-label">Final</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="openHistoryLog()" aria-label="Historial">
                    <span class="vn-control-icon">â˜°</span>
                    <span class="vn-control-label">Historial</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="toggleEmotePicker()" aria-label="Abrir selector de emotes">
                    <span class="vn-control-icon">â˜º</span>
                    <span class="vn-control-label">Emotes</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="openSettings()" aria-label="Ajustes">
                    <span class="vn-control-icon">âš™</span>
                    <span class="vn-control-label">Ajustes</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="openModal('shortcutsModal')" aria-label="Mostrar ayuda de atajos de teclado">
                    <span class="vn-control-icon">â”</span>
                    <span class="vn-control-label">Atajos</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn save-btn" onclick="quickSave()" aria-label="Guardar">
                    <span class="vn-control-icon">â—ˆ</span>
                    <span class="vn-control-label">Guardar</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button id="deleteTopicBtn" class="vn-control-btn hidden" onclick="deleteCurrentTopic()" aria-label="Borrar historia">
                    <span class="vn-control-icon">ğŸ—‘ï¸</span>
                    <span class="vn-control-label">Borrar</span>
                </button>
            </div>
            <div class="vn-control-slot">
                <button class="vn-control-btn" onclick="backToTopics()" aria-label="Salir">
                    <span class="vn-control-icon">â†©</span>
                    <span class="vn-control-label">Salir</span>
                </button>
            </div>
        </div>

        <!-- Emote Picker -->
        <div id="emotePicker" class="emote-picker">
            <button class="emote-btn" onclick="selectEmote('angry')" title="/angry" aria-label="Insertar emote angry">ğŸ’¢</button>
            <button class="emote-btn" onclick="selectEmote('happy')" title="/happy" aria-label="Insertar emote happy">âœ¨</button>
            <button class="emote-btn" onclick="selectEmote('shock')" title="/shock" aria-label="Insertar emote shock">ğŸ’¦</button>
            <button class="emote-btn" onclick="selectEmote('sad')" title="/sad" aria-label="Insertar emote sad">ğŸ’§</button>
            <button class="emote-btn" onclick="selectEmote('think')" title="/think" aria-label="Insertar emote think">ğŸ’­</button>
            <button class="emote-btn" onclick="selectEmote('love')" title="/love" aria-label="Insertar emote love">ğŸ’•</button>
            <button class="emote-btn" onclick="selectEmote('annoyed')" title="/annoyed" aria-label="Insertar emote annoyed">ğŸ’¢</button>
            <button class="emote-btn" onclick="selectEmote('embarrassed')" title="/embarrassed" aria-label="Insertar emote embarrassed">ğŸ˜³</button>
            <button class="emote-btn" onclick="selectEmote('idea')" title="/idea" aria-label="Insertar emote idea">ğŸ’¡</button>
            <button class="emote-btn" onclick="selectEmote('sleep')" title="/sleep" aria-label="Insertar emote sleep">ğŸ’¤</button>
        </div>

        <div id="vnSpriteContainer" class="vn-sprite-container"></div>

        <!-- Opciones flotantes -->
        <div id="vnOptionsContainer" class="vn-options-container"></div>

        <div class="vn-dialogue-box" onclick="handleDialogueClick()">
            <div id="messageHasOptions" class="message-has-options hidden">ğŸ­ Opciones disponibles</div>
            <div id="vnSpeakerAvatar" class="vn-speaker-avatar">ğŸ‘¤</div>
            <div id="vnSpeakerPlate" class="vn-speaker-plate">Nombre</div>
            <div id="vnDialogueText" class="vn-dialogue-text">...</div>
            <div id="vnContinueIndicator" class="vn-continue-indicator"></div>
            <div id="vnMessageCounter" class="vn-message-counter">0 / 0</div>
            <div class="vn-dialogue-actions">
                <button id="editMsgBtn" class="vn-dialogue-action-btn" data-tooltip="Editar mensaje" onclick="handleActionButtonClick(event); editCurrentMessage()">âœ</button>
                <button class="vn-dialogue-action-btn delete-message-btn" data-tooltip="Borrar mensaje" onclick="handleActionButtonClick(event); deleteCurrentMessage()">âŒ</button>
                <button class="vn-dialogue-action-btn" data-tooltip="Responder" onclick="handleActionButtonClick(event); openReplyPanel()">ğŸ’¬</button>
            </div>
        </div>

        <!-- Panel Responder -->
        <div id="vnReplyPanel" class="vn-reply-panel">
            <div class="vn-reply-header">
                <div class="vn-reply-title">
                    <span>ğŸ’¬</span>
                    <span id="replyPanelTitle">Responder</span>
                </div>
                <button onclick="closeReplyPanel()" class="btn-secondary" aria-label="Cerrar panel de respuesta">âœ• Cerrar</button>
            </div>

            <div class="vn-reply-body">
                <div class="char-selector-container" id="charSelectorContainer">
                    <div class="char-selector-main">
                        <div class="char-selected-display" id="charSelectedDisplay" onclick="toggleCharGrid()">
                            <div class="placeholder">ğŸ‘¤</div>
                        </div>
                        <div class="char-selected-info">
                            <div class="char-selected-name" id="charSelectedName">Selecciona personaje</div>
                            <div class="char-selected-hint">Click en el cÃ­rculo para cambiar</div>
                        </div>
                    </div>

                    <div class="char-grid-dropdown" id="charGridDropdown"></div>
                </div>

                <div class="narrator-toggle" id="narratorToggle" onclick="toggleNarratorMode()">
                    <input type="checkbox" id="narratorMode" onchange="event.stopPropagation()">
                    <label for="narratorMode">Modo Narrador</label>
                </div>

                <div class="vn-reply-textarea-wrap">
                    <button id="replyEmoteToggle" class="reply-emote-toggle" type="button" aria-label="Emotes" onclick="toggleReplyEmotePopover(event)">â˜º</button>
                    <textarea id="vnReplyText" class="vn-reply-textarea" placeholder="Escribe tu mensaje... Puedes usar **negrita** y *cursiva*, y comandos como /angry, /happy, etc."></textarea>
                    <div id="replyEmotePopover" class="reply-emote-popover" aria-hidden="true">
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('angry')" aria-label="Insertar emote angry">ğŸ’¢</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('happy')" aria-label="Insertar emote happy">âœ¨</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('shock')" aria-label="Insertar emote shock">ğŸ’¦</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('sad')" aria-label="Insertar emote sad">ğŸ’§</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('think')" aria-label="Insertar emote think">ğŸ’­</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('love')" aria-label="Insertar emote love">ğŸ’•</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('annoyed')" aria-label="Insertar emote annoyed">ğŸ’¢</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('embarrassed')" aria-label="Insertar emote embarrassed">ğŸ˜³</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('idea')" aria-label="Insertar emote idea">ğŸ’¡</button>
                        <button class="reply-emote-btn" type="button" onclick="selectReplyEmote('sleep')" aria-label="Insertar emote sleep">ğŸ’¤</button>
                    </div>
                </div>

                <div class="options-toggle-container" id="optionsToggleContainer">
                    <div class="options-toggle" onclick="toggleOptionsFields()">
                        <input type="checkbox" id="enableOptions" onchange="event.stopPropagation()">
                        <label for="enableOptions">ğŸ­ Crear opciones de elecciÃ³n</label>
                    </div>

                    <div id="optionsFields" class="options-fields">
                        <div class="option-field-group">
                            <div class="option-field-header"><span>â‘ </span><span>OpciÃ³n 1</span></div>
                            <input type="text" id="option1Text" class="option-input" placeholder="Texto de la opciÃ³n">
                            <textarea id="option1Continuation" class="option-textarea" placeholder="ContinuaciÃ³n narrativa..."></textarea>
                        </div>
                        <div class="option-field-group">
                            <div class="option-field-header"><span>â‘¡</span><span>OpciÃ³n 2</span></div>
                            <input type="text" id="option2Text" class="option-input" placeholder="Texto de la opciÃ³n">
                            <textarea id="option2Continuation" class="option-textarea" placeholder="ContinuaciÃ³n narrativa..."></textarea>
                        </div>
                        <div class="option-field-group">
                            <div class="option-field-header"><span>â‘¢</span><span>OpciÃ³n 3</span></div>
                            <input type="text" id="option3Text" class="option-input" placeholder="Texto de la opciÃ³n">
                            <textarea id="option3Continuation" class="option-textarea" placeholder="ContinuaciÃ³n narrativa..."></textarea>
                        </div>

                        <button class="branch-editor-btn" onclick="openBranchEditor()">
                            <span>ğŸŒ¿</span>
                            <span>Editor Avanzado de Ramas</span>
                        </button>
                    </div>
                </div>

                <!-- Selector de clima (solo en modo fanfic o al responder) -->
                <div id="weatherSelectorContainer" style="display: none; margin-top: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">ğŸŒ¦ï¸ Cambiar clima</label>
                    <div class="weather-selector">
                        <button class="weather-btn active" onclick="setWeather('none')">â˜€ï¸ Normal</button>
                        <button class="weather-btn" onclick="setWeather('rain')">ğŸŒ§ï¸ Lluvia</button>
                        <button class="weather-btn" onclick="setWeather('fog')">ğŸŒ«ï¸ Niebla</button>
                    </div>
                </div>
            </div>

            <div class="vn-reply-footer">
                <button class="btn-secondary" onclick="closeReplyPanel()">Cancelar</button>
                <button class="btn-primary" onclick="postVNReply()" id="submitReplyBtn">Enviar Mensaje</button>
            </div>
        </div>
    </div>

    <!-- History Log Modal -->
    <div id="historyModal" class="modal-overlay" onclick="if(event.target === this) closeModal('historyModal')">
        <div class="history-modal">
            <div class="history-header">
                <h3 class="history-title">ğŸ“œ Historial de la Historia</h3>
                <button onclick="closeModal('historyModal')" class="btn-secondary" aria-label="Cerrar historial">âœ• Cerrar</button>
            </div>
            <div id="historyContent" class="history-content"></div>
        </div>
    </div>

    <!-- Branch Editor Modal -->
    <div id="branchEditorModal" class="modal-overlay" onclick="if(event.target === this) closeModal('branchEditorModal')">
        <div class="branch-editor-modal">
            <div class="branch-editor-header">
                <h3 class="branch-editor-title">ğŸŒ¿ Editor de Ramas Narrativas</h3>
                <button onclick="closeModal('branchEditorModal')" class="btn-secondary">âœ•</button>
            </div>
            <div class="branch-editor-content">
                <div id="branchList" class="branch-list"></div>
                <button class="add-branch-btn" onclick="addNewBranch()">
                    <span>+</span> Agregar nueva rama
                </button>
            </div>
            <div class="branch-editor-footer">
                <button onclick="closeModal('branchEditorModal')" class="btn-secondary">Cancelar</button>
                <button onclick="saveBranches()" class="btn-primary">ğŸ’¾ Guardar Ramas</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="topicModal" class="modal-overlay" onclick="if(event.target === this) closeModal('topicModal')">
        <div class="modal topic-modal">
            <h3 class="topic-title">Nueva Historia</h3>

            <div class="topic-modal-body">

            <!-- Selector de modo compacto -->
            <div class="form-group">
                <label style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.8rem; display: block;">Modo de historia</label>
                <div class="topic-mode-toggle">
                    <label class="topic-mode-option active">
                        <input type="radio" name="topicMode" value="roleplay" id="modeRoleplay" checked onchange="updateTopicModeUI()">
                        <span>ğŸ­ Modo rol</span>
                    </label>
                    <label class="topic-mode-option">
                        <input type="radio" name="topicMode" value="fanfic" id="modeFanfic" onchange="updateTopicModeUI()">
                        <span>ğŸ“– Modo historia</span>
                    </label>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.55rem;">El inicio siempre serÃ¡ como <strong>Narrador</strong>. El flujo adicional del modo rol se realiza despuÃ©s de crear la historia.</div>
            </div>

            <!-- TÃ­tulo -->
            <div class="form-group">
                <label style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; display: block;">TÃ­tulo *</label>
                <input type="text" id="topicTitleInput" placeholder="TÃ­tulo de la historia...">
            </div>

            <!-- Texto inicial -->
            <div class="form-group topic-inicio-group">
                <label style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; display: block;">Inicio *</label>
                <textarea id="topicFirstMsg" name="inicio" rows="3" placeholder="Primer mensaje de la historia..."></textarea>
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.3rem;">Puedes usar **negrita** y *cursiva*</div>
            </div>

            <!-- Fondo personalizado -->
            <div class="form-group topic-inline-field">
                <label>Fondo (URL)</label>
                <input type="text" id="topicBackgroundInput" placeholder="https://ejemplo.com/imagen.jpg">
            </div>

            <!-- Selector de clima -->
            <div class="form-group">
                <label style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.8rem; display: block;">AmbientaciÃ³n</label>
                <div class="topic-weather-grid">
                    <button type="button" class="weather-btn topic-weather-btn active" onclick="setTopicWeather('none')" aria-label="AmbientaciÃ³n normal" title="Normal"><span class="weather-icon">â˜€ï¸</span><span class="weather-label">Normal</span></button>
                    <button type="button" class="weather-btn topic-weather-btn" onclick="setTopicWeather('rain')" aria-label="AmbientaciÃ³n lluvia" title="Lluvia"><span class="weather-icon">ğŸŒ§ï¸</span><span class="weather-label">Lluvia</span></button>
                    <button type="button" class="weather-btn topic-weather-btn" onclick="setTopicWeather('fog')" aria-label="AmbientaciÃ³n niebla" title="Niebla"><span class="weather-icon">ğŸŒ«ï¸</span><span class="weather-label">Niebla</span></button>
                </div>
                <input type="hidden" id="topicWeatherInput" value="none">
            </div>
            </div>

            <!-- Botones de acciÃ³n -->
            <div class="topic-modal-footer">
                <button onclick="closeModal('topicModal')" class="btn-secondary" style="padding: 0.7rem 1.5rem;">Cancelar</button>
                <button onclick="createTopic()" class="btn-primary topic-create-btn">âœ¨ Crear Historia</button>
            </div>
        </div>
    </div>

    <div id="roleCharacterModal" class="modal-overlay" onclick="if(event.target === this) closeModal('roleCharacterModal')">
        <div class="role-char-modal">
            <h3 style="margin:0; text-align:center; color: var(--accent-gold);">Selecciona tu personaje activo</h3>
            <div style="text-align:center; color: var(--text-muted); font-size: 0.95rem;">En modo rol solo puedes usar un personaje por historia.</div>
            <div id="roleCharacterGrid" class="role-char-grid"></div>
            <button class="btn-secondary" onclick="closeModal('roleCharacterModal')">Cancelar</button>
        </div>
    </div>

    <!-- Character Editor -->
    <div id="characterModal" class="modal-overlay" onclick="if(event.target === this) closeModal('characterModal')">
        <div class="character-modal">
            <div class="editor-container">
                <div class="editor-preview">
                    <div class="editor-preview-image" id="editorPreviewImage">
                        <span style="font-size: 5rem;">ğŸ‘¤</span>
                    </div>
                    <div class="editor-preview-name" id="editorPreviewName">Nuevo Personaje</div>
                    <div class="editor-preview-hint">Vista previa en tiempo real</div>
                </div>

                <div class="editor-form">
                    <input type="hidden" id="editCharacterId">

                    <div class="editor-tabs">
                        <button class="editor-tab active" onclick="switchEditorTab('identity', this)">
                            <span>ğŸ‘¤</span> Identidad
                        </button>
                        <button class="editor-tab" onclick="switchEditorTab('biography', this)">
                            <span>ğŸ“–</span> BiografÃ­a
                        </button>
                        <button class="editor-tab" onclick="switchEditorTab('notes', this)">
                            <span>ğŸ“</span> Notas
                        </button>
                    </div>

                    <div class="editor-content">
                        <div id="editor-tab-identity" class="editor-panel active">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nombre *</label>
                                    <input type="text" id="charName" oninput="updatePreview()">
                                </div>
                                <div class="form-group">
                                    <label>Apellido</label>
                                    <input type="text" id="charLastName" oninput="updatePreview()">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Edad</label>
                                    <input type="text" id="charAge">
                                </div>
                                <div class="form-group">
                                    <label>Raza/Origen</label>
                                    <input type="text" id="charRace">
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label>GÃ©nero</label>
                                <div class="gender-selector">
                                    <div class="gender-option" onclick="selectGender('Femenino', this)">â™€ï¸</div>
                                    <div class="gender-option" onclick="selectGender('Masculino', this)">â™‚ï¸</div>
                                    <div class="gender-option" onclick="selectGender('No Binario', this)">âšª</div>
                                </div>
                                <input type="hidden" id="charGender">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Alineamiento</label>
                                    <select id="charAlignment">
                                        <option value="">Seleccionar...</option>
                                        <option value="LB">Legal Bueno</option>
                                        <option value="LN">Legal Neutral</option>
                                        <option value="LM">Legal Malvado</option>
                                        <option value="NB">Neutral Bueno</option>
                                        <option value="NN">Neutral Neutral</option>
                                        <option value="NM">Neutral Malvado</option>
                                        <option value="CB">CaÃ³tico Bueno</option>
                                        <option value="CN">CaÃ³tico Neutral</option>
                                        <option value="CM">CaÃ³tico Malvado</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>OcupaciÃ³n</label>
                                    <input type="text" id="charJob">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Color</label>
                                    <input type="color" id="charColor" value="#8b7355" style="height: 45px; width: 100%;">
                                </div>
                                <div class="form-group">
                                    <label>Avatar URL</label>
                                    <input type="text" id="charAvatar" oninput="updatePreview()">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Sprite URL (cuerpo completo)</label>
                                <input type="text" id="charSprite">
                            </div>
                        </div>

                        <div id="editor-tab-biography" class="editor-panel">
                            <div class="form-group">
                                <label>DescripciÃ³n FÃ­sica</label>
                                <textarea id="charBasic" placeholder="Describe la apariencia de tu personaje..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Personalidad</label>
                                <textarea id="charPersonality" placeholder="Â¿CÃ³mo es su comportamiento? Â¿QuÃ© le motiva?"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Historia / Trasfondo</label>
                                <textarea id="charHistory" rows="6" placeholder="Su pasado, orÃ­genes, eventes importantes..."></textarea>
                            </div>
                        </div>

                        <div id="editor-tab-notes" class="editor-panel">
                            <div class="form-group">
                                <label>Notas Libres</label>
                                <textarea id="charNotes" rows="12" placeholder="Habilidades, equipo, magias, relaciones, o cualquier otro dato importante..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="editor-actions">
                        <button onclick="closeModal('characterModal')" class="btn-secondary">Cancelar</button>
                        <button id="deleteCharBtn" onclick="deleteCharFromModal()" class="btn-danger" style="display: none;">ğŸ—‘ï¸ Borrar</button>
                        <button onclick="saveCharacter()" class="btn-primary">ğŸ’¾ Guardar Personaje</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="sheetModal" class="modal-overlay" onclick="if(event.target === this) closeModal('sheetModal')">
        <div class="sheet-modal">
            <div class="sheet-header">
                <div id="sheetAvatar" class="sheet-avatar-large"></div>
                <div class="sheet-header-info">
                    <h2 id="sheetName" class="sheet-name"></h2>
                    <p id="sheetOwner" class="sheet-owner"></p>
                    <div id="sheetQuickStats" class="sheet-quick-stats"></div>
                </div>
            </div>
            <div class="sheet-tabs">
                <button class="sheet-tab active" onclick="switchTab('profile')">ğŸ“‹ Perfil</button>
                <button class="sheet-tab" onclick="switchTab('personality')">ğŸ­ Personalidad</button>
                <button class="sheet-tab" onclick="switchTab('history')">ğŸ“– Historia</button>
            </div>
            <div class="sheet-body">
                <div class="sheet-content">
                    <div id="tab-profile" class="tab-panel active">
                        <div class="profile-grid" id="profileGrid"></div>
                    </div>
                    <div id="tab-personality" class="tab-panel">
                        <div class="profile-text" id="profilePersonality">Sin datos de personalidad.</div>
                    </div>
                    <div id="tab-history" class="tab-panel">
                        <div class="profile-text" id="profileHistory">Sin historia registrada.</div>
                    </div>
                </div>
            </div>
            <div class="sheet-actions">
                <button onclick="closeModal('sheetModal')" class="btn-secondary">Cerrar</button>
                <button id="sheetEditBtn" onclick="editFromSheet()" class="btn-primary" style="display: none;">âœï¸ Editar</button>
            </div>
        </div>
    </div>

<!-- Orden de carga recomendado: utilidades -> UI -> arranque -->
<script src="js/utils/state.js"></script>
<script src="js/utils/storage.js"></script>
<script src="js/ui/interface.js"></script>
<script src="js/app.js"></script>
</body>
</html>
